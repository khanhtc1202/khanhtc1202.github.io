<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Process, Thread and Routine</title>
	<meta name="description" content="khanhtc personal&#39;s note">
	<meta name="author" content="khanhtc">
	
		<link rel="preconnect" href="https://cse.google.com">
		<link rel="preconnect" href="https://www.googleapis.com">
		<link rel="preconnect" href="https://www.google.com">
		<link rel="preconnect" href="https://clients1.google.com">
	
	
		<link rel="preconnect" href="https://cdn.mathjax.org">
	
	
</head>
<body>
	<header id="header">
	<a href="https://khanhtc1202.github.io/">khanhtc&#39;s blog</a> | ğŸ“£ <a href="https://khanhtc1202.github.io/index.xml">RSS</a> | ğŸ‘€ <a href="https://khanhtc1202.github.io/alive">Liveness check</a>
	<div class="gcse-search"></div>
	
	<nav>
		<ul>
			
			<li><a href="/about">about</a></li>
			
			<li><a href="https://github.com/khanhtc1202">github</a></li>
			
			<li><a href="https://leetcode.com/khanhtc">leetcode</a></li>
			
			<li><a href="https://www.linkedin.com/in/khanhtc1202">linkedin</a></li>
			
		</ul>
	</nav>
	
</header>

	
	<main>
		<article>
			<h1>Process, Thread and Routine</h1>
			<time>28.02.2020 03:56</time>
			<div>
				<h2 id="process-and-thread">Process and Thread</h2>
<h3 id="process">Process</h3>
<p>Tiáº¿n trÃ¬nh cÃ³ thá»ƒ hiá»ƒu Ä‘Æ¡n giáº£n lÃ  má»™t chÆ°Æ¡ng trÃ¬nh Ä‘ang cháº¡y trong mÃ¡y tÃ­nh. Khi chÃºng ta má»Ÿ má»™t trang web trÃ¬nh duyá»‡t thÃ¬ Ä‘Ã¢y Ä‘Æ°á»£c xem lÃ  má»™t tiáº¿n trÃ¬nh. Khi chÃºng ta viáº¿t 1 chÆ°Æ¡ng trÃ¬nh mÃ¡y tÃ­nh báº±ng ngÃ´n ngá»¯ láº­p trÃ¬nh nhÆ° C, Java, hay Go, sau khi tiáº¿n hÃ nh biÃªn dá»‹ch vÃ  cháº¡y chÆ°Æ¡ng trÃ¬nh thÃ¬ há»‡ Ä‘iá»u hÃ nh sáº½ cáº¥p cho chÆ°Æ¡ng trÃ¬nh má»™t khÃ´ng gian bá»™ nhá»› nháº¥t Ä‘á»‹nh, PID (process ID),&hellip; Má»—i tiáº¿n trÃ¬nh cÃ³ Ã­t nháº¥t má»™t luá»“ng chÃ­nh (main thread) Ä‘á»ƒ cháº¡y chÆ°Æ¡ng trÃ¬nh, nÃ³ nhÆ° lÃ  xÆ°Æ¡ng sá»‘ng cá»§a chÆ°Æ¡ng trÃ¬nh váº­y. Khi luá»“ng chÃ­nh nÃ y ngá»«ng hoáº¡t Ä‘á»™ng tÆ°Æ¡ng á»©ng vá»›i viá»‡c chÆ°Æ¡ng trÃ¬nh bá»‹ táº¯t.</p>
<h3 id="thread">Thread</h3>
<p>Thread hay Ä‘Æ°á»£c gá»i lÃ  tiá»ƒu trÃ¬nh nÃ³ lÃ  má»™t luá»“ng trong tiáº¿n trÃ¬nh Ä‘ang cháº¡y. CÃ¡c luá»“ng Ä‘Æ°á»£c cháº¡y song song trong má»—i tiáº¿n trÃ¬nh vÃ  cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n vÃ¹ng nhá»› Ä‘Æ°á»£c cung cáº¥p bá»Ÿi tiáº¿n trÃ¬nh, cÃ¡c tÃ i nguyÃªn cá»§a há»‡ Ä‘iá»u hÃ nh,&hellip;</p>
<p><img src="https://user-images.githubusercontent.com/32532742/70388904-75ad5180-19fb-11ea-9ca7-29eb9bc0654b.png" alt="inner-process"></p>
<ul>
<li>CÃ¡c thread trong process sáº½ Ä‘Æ°á»£c cáº¥p phÃ¡t riÃªng má»™t vÃ¹ng nhá»› <code>stack</code> Ä‘á»ƒ lÆ°u cÃ¡c biáº¿n riÃªng cá»§a thread Ä‘Ã³. Stack Ä‘Æ°á»£c cáº¥p phÃ¡t cá»‘ Ä‘á»‹nh khoáº£ng 1MB-2MB.</li>
<li>CÃ¡c thread chia sáº» chung vÃ¹ng nhá»› <code>heap cá»§a process</code>. ( cÃ¡c process khÃ´ng chung memory resource - Ä‘Æ°á»£c Ä‘áº£m báº£o bá»Ÿi OS )</li>
</ul>
<h4 id="há»‡-quáº£">Há»‡ quáº£</h4>
<ul>
<li>Khi process táº¡o <strong>quÃ¡ nhiá»u thread sáº½ dáº«n Ä‘áº¿n tÃ¬nh tráº¡ng stack overflow</strong>.</li>
<li>Stack overflow khi thread thá»±c thi hÃ m gá»i hÃ m Ä‘á»‡ quy sÃ¢u.</li>
<li>Thread stack size cá»‘ Ä‘á»‹nh cÅ©ng gÃ¢y lÃ£ng phÃ­ náº¿u thread Ä‘Ã³ chá»‰ cháº¡y task Ä‘Æ¡n giáº£n.</li>
<li>Khi <strong>cÃ¡c thread sá»­ dá»¥ng chung vÃ¹ng nhá»› sáº½ dá»… gÃ¢y ra hiá»‡n tÆ°á»£ng race condition</strong>.</li>
<li><strong>Sá»‘ lÆ°á»£ng thread cháº¡y song song trong cÃ¹ng má»™t thá»i Ä‘iá»ƒm sáº½ báº±ng vá»›i sá»‘ lÆ°á»£ng nhÃ¢n CPU mÃ  mÃ¡y tÃ­nh chÃºng ta cÃ³</strong>. Theo kinh nghiá»‡m láº­p trÃ¬nh chÃºng ta chá»‰ nÃªn táº¡o sá»‘ thread báº±ng sá»‘ nhÃ¢n <code>CPU * 2</code>. ( báº£n cháº¥t sá»‘ thread Ä‘Æ°á»£c sinh ra trong process khÃ´ng bá»‹ giá»›i háº¡n náº¿u khÃ´ng tÃ­nh Ä‘áº¿n váº¥n Ä‘á» stack overflow nhÆ° há»‡ quáº£ 1 nÃ³i trÃªn, tuy nhiÃªn sá»‘ lÆ°á»£ng thread tá»‘i Ä‘a cháº¡y trong cÃ¹ng 1 thá»i Ä‘iá»ƒm báº±ng sá»‘ cpu cá»§a há»‡ Ä‘iá»u hÃ nh - xem láº¡i image 2 ).</li>
</ul>
<h3 id="thread-in-action">Thread in action</h3>
<p><strong>Táº¡i má»™t thá»i Ä‘iá»ƒm chá»‰ cÃ³ má»™t tÃ¡c vá»¥ Ä‘Æ°á»£c xá»­ lÃ½ hay má»™t thread Ä‘Æ°á»£c cháº¡y trÃªn má»™t nhÃ¢n CPU</strong>. Khi nhÃ¢n CPU chuyá»ƒn qua xá»­ lÃ½ tÃ¡c vá»¥ khÃ¡c cÅ©ng cÃ³ nghÄ©a lÃ  thread khÃ¡c Ä‘Æ°á»£c cháº¡y. Thao tÃ¡c Ä‘Ã³ Ä‘Æ°á»£c gá»i lÃ  <code>context switch</code>.</p>
<p>Context switch xáº£y ra dá»±a trÃªn cÆ¡ cháº¿ cpu cycle time: sau má»—i khoáº£ng thá»i gian cá»‘ Ä‘á»‹nh, hardware timer interrupt processor, trigger kernel scheduler. HÃ m scheduler cá»§a kernel sáº½ dá»«ng thá»±c thi cÃ¡c thread ( os thread ) hiá»‡n táº¡i, lÆ°u láº¡i cÃ¡c giÃ¡ trá»‹ trÃªn register cá»§a cÃ¡c thread Ä‘Ã³ vÃ o thread local storage ( trÃªn memory ), kiá»ƒm tra láº¡i list cÃ¡c thread Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ­ vá»›i os, chá»n ra cÃ¡c thread sáº½ Ä‘Æ°á»£c thá»±c thi tiáº¿p theo, restore cÃ¡c giÃ¡ trá»‹ cáº§n dÃ¹ng Ä‘á»ƒ thá»±c thi cÃ¡c thread Ä‘Ã³ tá»« memory vÃ  tiáº¿n hÃ nh thá»±c thi. // chi phÃ­ cho context switch lÃ  tá»‘n kÃ©m!</p>
<p>chi tiáº¿t hÆ¡n cÃ³ thá»ƒ xem táº¡i: <a href="https://books.google.co.jp/books?id=SJHvCgAAQBAJ&amp;pg=PT362&amp;lpg=PT362&amp;dq=goroutines%20stack%201gb&amp;source=bl&amp;ots=qzkKDXeZvf&amp;sig=ACfU3U33DUanUlDn9HYx8I58IeWqfpaPEA&amp;hl=ja&amp;sa=X&amp;ved=2ahUKEwi-j8Sh8J7mAhWWPXAKHdXdDW4Q6AEwBHoECAoQAQ#v=onepage&amp;q=goroutines%20stack%201gb&amp;f=false">Ä‘Ã¢y</a>.</p>
<h4 id="conclusion-about-thread-and-process">Conclusion about thread and process</h4>
<ul>
<li><strong>OS thread != program thread</strong>, tuy nhiÃªn trong execution context, chÃºng cÃ³ tÆ°Æ¡ng quan 1:1</li>
<li>OS thread chá»‰ sá»‘ task processor cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘k trong cÃ¹ng 1 thá»i Ä‘iá»ƒm ( = CPU number )</li>
<li>sá»‘ lÆ°á»£ng thread táº¡o Ä‘Æ°á»£c trong 1 program chá»‰ bá»‹ giá»›i háº¡n bá»Ÿi bá»™ nhá»› stack cá»§a process cháº¡y program Ä‘Ã³ ( phá»¥ thuá»™c vÃ o stack Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi OS )</li>
</ul>
<h2 id="routine--in-golang--">Routine ( in Golang :) )</h2>
<p>So sÃ¡nh vá»›i thread trong cÃ¡c ngÃ´n ngá»¯ khÃ¡c ( eg. java )</p>
<ul>
<li>Má»™t Goroutines sáº½ Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng má»™t vÃ¹ng nhá»› nhá» (8KB).</li>
<li>Khi gá»i Ä‘á»‡ quy sÃ¢u (khÃ´ng gian stack hiá»‡n táº¡i lÃ  khÃ´ng Ä‘á»§) Goroutines sáº½ tá»± Ä‘á»™ng tÄƒng khÃ´ng gian stack (kÃ­ch thÆ°á»›c tá»‘i Ä‘a cá»§a stack cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘áº¡t tá»›i 1GB).</li>
<li>model <code>M goroutine : N thread</code>. Biáº¿n <code>runtime.GOMAXPROCS</code> quy Ä‘á»‹nh sá»‘ lÆ°á»£ng thread ( prog thread ) hiá»‡n thá»i Ä‘ang Ä‘Æ°á»£c handle bá»Ÿi go runtime ( sá»‘ n trong model ).</li>
</ul>
<h3 id="go-model-in-action">go model in action</h3>
<p>Äá»ƒ test model <code>m routines : n threads</code>, cÃ³ thá»ƒ thÃ­ nghiá»‡m nhÆ° sau</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#080;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">go</span> <span style="color:#038">print</span>(<span style="color:#00d;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#038">print</span>(<span style="color:#00d;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>then</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#369">GOMAXPROCS</span>=<span style="color:#00d;font-weight:bold">1</span> go run main.go
</span></span><span style="display:flex;"><span>11111111111111100000000000000011...
</span></span><span style="display:flex;"><span>$ <span style="color:#369">GOMAXPROCS</span>=<span style="color:#00d;font-weight:bold">2</span> go run main.go
</span></span><span style="display:flex;"><span>01010101010101010101010101010101...
</span></span></code></pre></div><p>á» trÆ°á»ng há»£p Ä‘áº§u ( runtime handle 1 thread pro ~ 1 os thread ), cÃ³ 2 goroutine cháº¡y trong prog tuy nhiÃªn cÃ³ duy nháº¥t 1 thread pro ~ 1 os thread do Ä‘Ã³ tá»‘i Ä‘a 1 routine thá»±c thi trong 1 thá»i Ä‘iá»ƒm, switch value 0-1 xáº£y ra táº¡i interrupt cá»§a hardware. <br>
á» trÆ°á»ng há»£p sau ( runtime handle 2 thread pro ~ 2 os thread ), prog cÃ³ thá»ƒ cÃ³ tá»‘i Ä‘a 2 thread cháº¡y trong cÃ¹ng 1 thá»i Ä‘iá»ƒm Ä‘Æ°á»£c khai bÃ¡o vá»›i os. CÅ©ng tÆ°Æ¡ng tá»± nhÆ° trÃªn, vá»›i 2 goroutine cháº¡y trong prog, runtime cÃ³ thá»ƒ cho 2 routine thá»±c thi Ä‘á»“ng thá»i táº¡i má»i thá»i Ä‘iá»ƒm ( khÃ´ng nháº­n ra Ä‘k interrupt cá»§a hardware ).</p>
<p><strong>but</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#369">GOMAXPROCS</span>=<span style="color:#00d;font-weight:bold">1</span> go run main.go
</span></span><span style="display:flex;"><span>1111111111111111111111111111111111111.....111111111110000000000000000000000...000....
</span></span><span style="display:flex;"><span>$ <span style="color:#369">GOMAXPROCS</span>=<span style="color:#00d;font-weight:bold">2</span> go run main.go
</span></span><span style="display:flex;"><span>111111111111111000000000000000111111111111111000000000000000111111111111111000...
</span></span></code></pre></div><p>( chÃº Ã½: sá»‘ sá»‘ 1 vÃ  0 trong má»—i block pháº£i báº±ng nhau )</p>
<p>Trong thá»±c táº¿ 1 cycle time cá»§a cpu hiá»‡n Ä‘áº¡i ( 1 lÆ°á»£t thread os execute ) dÃ i hÆ¡n nhiá»u so vá»›i thá»i gian cháº¡y cá»§a 1 statement trong goroutine ( hay cáº£ thread prog ) do Ä‘Ã³, cÃ³ thá»ƒ kháº³ng Ä‘á»‹nh sá»± khÃ¡c biá»‡t giá»¯a os thread vÃ  prog thread.</p>
<p>Äá»c thÃªm táº¡i <a href="https://github.com/khanhtc1202/til/issues/32">Ä‘Ã¢y</a>&hellip;</p>

			</div>
			
			<div>
				<ul id="tags">
					
					<li><a href="/tags/concurrent">concurrent</a></li>
					
					<li><a href="/tags/os">os</a></li>
					
				</ul>
			</div>
			
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/cncf-ambassador-annoucement/">Cncf Ambassador Annoucement</a></li>
				
				<li><a href="/posts/kadane-and-its-applications/">From subarray problems to Kadane and applications</a></li>
				
				<li><a href="/posts/an-approach-for-dp-problem/">An Approach for DP Problem</a></li>
				
				<li><a href="/posts/some-thought-about-tactics/">A breakthrough of my mind</a></li>
				
				<li><a href="/posts/concurrent-unit/">Process, Thread and Routine</a></li>
				
			</ul>
		</div>
	</div>
</aside>

<aside>
	<div>
    		
			<div>
				<h3>TAGS</h3>
			</div>
			<div>
				<ul>
					
					<li><a href="/tags/algorithm">algorithm</a></li>
					
					<li><a href="/tags/annoucement">annoucement</a></li>
					
					<li><a href="/tags/approx">approx</a></li>
					
					<li><a href="/tags/architecture">architecture</a></li>
					
					<li><a href="/tags/c/c&#43;&#43;">c/c&#43;&#43;</a></li>
					
					<li><a href="/tags/cncf">cncf</a></li>
					
					<li><a href="/tags/code">code</a></li>
					
					<li><a href="/tags/community">community</a></li>
					
					<li><a href="/tags/compiler">compiler</a></li>
					
					<li><a href="/tags/concurrent">concurrent</a></li>
					
					<li><a href="/tags/database">database</a></li>
					
					<li><a href="/tags/design">design</a></li>
					
					<li><a href="/tags/dev%20tool">dev tool</a></li>
					
					<li><a href="/tags/golang">golang</a></li>
					
					<li><a href="/tags/javascript">javascript</a></li>
					
					<li><a href="/tags/lock">lock</a></li>
					
					<li><a href="/tags/manual">manual</a></li>
					
					<li><a href="/tags/memory">memory</a></li>
					
					<li><a href="/tags/networks">networks</a></li>
					
					<li><a href="/tags/nodejs">nodejs</a></li>
					
					<li><a href="/tags/oop">oop</a></li>
					
					<li><a href="/tags/os">os</a></li>
					
					<li><a href="/tags/package%20manager">package manager</a></li>
					
					<li><a href="/tags/programming">programming</a></li>
					
					<li><a href="/tags/react">react</a></li>
					
					<li><a href="/tags/tactics">tactics</a></li>
					
					<li><a href="/tags/thinking">thinking</a></li>
					
					<li><a href="/tags/tree">tree</a></li>
					
					<li><a href="/tags/trick">trick</a></li>
					
				</ul>
			</div>
		
	</div>
</aside>



	<footer id="footer">
	<p>&copy; 2017-2024 <a href="https://khanhtc1202.github.io/">khanhtc&#39;s blog</a> | <a href="https://khanhtc1202.github.io/index.xml">RSS</a></p>
	<section><script async src="https://cse.google.com/cse.js?cx=009971123916912295303:lpg9aljzbui"></script>

	</section>
</footer>

</body>
</html>
