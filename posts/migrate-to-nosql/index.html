<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Migrate to NoSql</title>
	<meta name="description" content="khanhtc personal&#39;s note">
	<meta name="author" content="khanhtc">
	
		<link rel="preconnect" href="https://cse.google.com">
		<link rel="preconnect" href="https://www.googleapis.com">
		<link rel="preconnect" href="https://www.google.com">
		<link rel="preconnect" href="https://clients1.google.com">
	
	
		<link rel="preconnect" href="https://cdn.mathjax.org">
	
	
</head>
<body>
	<header id="header">
	<a href="https://khanhtc1202.github.io/">khanhtc&#39;s blog</a> | üì£ <a href="https://khanhtc1202.github.io/index.xml">RSS</a> | üëÄ <a href="https://khanhtc1202.github.io/alive">Liveness check</a>
	<div class="gcse-search"></div>
	
	<nav>
		<ul>
			
			<li><a href="/about">about</a></li>
			
			<li><a href="https://github.com/khanhtc1202">github</a></li>
			
			<li><a href="https://leetcode.com/khanhtc">leetcode</a></li>
			
			<li><a href="https://www.linkedin.com/in/khanhtc1202">linkedin</a></li>
			
		</ul>
	</nav>
	
</header>

	
	<main>
		<article>
			<h1>Migrate to NoSql</h1>
			<time>10.07.2019 22:34</time>
			<div>
				<p>M·ªôt ƒëi·ªÅu ƒë∆∞·ª£c nh·∫Øc ƒë·∫øn r·∫•t nhi·ªáu khi chuy·ªÉn t·ª´ sql sang nosql l√† c√°ch ƒë·ªÉ l∆∞u tr·ªØ quan h·ªá gi·ªØa c√°c ƒë·ªëi t∆∞·ª£ng trong database. M·ªôt ƒë·ªëi t∆∞·ª£ng th∆∞·ªùng r·∫•t √≠t khi t·ªìn t·∫°i ƒë·ªôc l√¢p trong m·ªôt h·ªá th·ªëng m√† n·∫Øm gi·ªØ 1 ph·∫ßn th√¥ng tin ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o ra m·ªôt ƒë·ªëi t∆∞·ª£ng kh√°c.</p>
<!-- more -->
<p>C√°c d·∫°ng quan h·ªá ch√≠nh gi·ªØa c√°c ƒë·ªëi t∆∞·ª£ng c√≥ th·ªÉ l∆∞u ƒë∆∞·ª£c trong c∆° s·ªü d·ªØ li·ªáu quan h·ªá bao g·ªìm</p>
<ul>
<li>One-to-One</li>
<li>One-to-N</li>
<li>N-to-N</li>
</ul>
<p>T·∫•t nhi√™n, trong c√°c lo·∫°i ƒë√£ ƒë∆∞·ª£c li·ªát k√™ ph√≠a tr√™n, quan h·ªá N-to-N th∆∞·ªùng √≠t th·∫•y do ƒë∆∞·ª£c chuy·ªÉn th√†nh 2 quan h·ªá One-to-N ( v√† t·ªët nh·∫•t l√† n√≥ n√™n ƒë∆∞·ª£c chuy·ªÉn nh∆∞ th·∫ø :smile: ), quan h·ªá One-to-One th√¨ kh√° c∆° b·∫£n v√† kh√¥ng g·∫∑p v·∫•n ƒë·ªÅ khi chuy·ªÉn t·ª´ sql sang nosql. V·∫≠y v·∫•n ƒë·ªÅ ch√≠nh c·∫ßn gi·∫£i quy·∫øt l√† t√¨m c√¢u tr·∫£ l·ªùi cho vi·ªác th·∫ø hi·ªán quan h·ªá One-to-N m·ªôt c√°ch hi·ªáu qu·∫£ trong nosql.</p>
<p>ƒê·ªÉ ph·ªß ƒë·∫ßu m·ªçi tranh lu·∫≠n, c√¢u tr·∫£ l·ªùi ng·∫Øn g·ªçn cho c√¢u tr·∫£ l·ªùi tr√™n l√†: <strong>kh√¥ng c√≥ ph∆∞∆°ng ph√°p c·ªë ƒë·ªãnh n√†o ƒë·ªÉ √°p d·ª•ng khi chuy·ªÉn quan h·ªá One-to-N t·ª´ sql sang nosql!</strong> N√≥ ph·ª• thu·ªôc v√†o m·ªôt s·ªë tr∆∞·ªùng h·ª£p c·ª• th·ªÉ, c≈©ng nh∆∞ y√™u c·∫ßu c·ªßa h·ªá th·ªëng v√† ƒë·∫∑c ƒëi·ªÉm c·ªßa d·ªØ li·ªáu ƒë·ªÉ ng∆∞·ªùi thi·∫øt k·∫ø c√≥ th·ªÉ quy·∫øt ƒë·ªãnh c√°ch n√†o l√† hi·ªáu qu·∫£.</p>
<p>ƒê·ªÉ ƒë∆∞a ra thi·∫øt k·∫ø ph√π h·ª£p cho d·ªØ li·ªáu c√≥ quan h·ªá One-to-N, m·ªôt c√¢u h·ªèi ƒë∆∞·ª£c ƒë·∫∑t ra: Cardinality ( l·ª±c l∆∞·ª£ng hay s·ªë s·ªë ph·∫ßn t·ª≠ c·ªßa m·ªôt t·∫≠p h·ª£p ) c·ªßa t·∫≠p N trong m·ªëi quan h·ªá ƒë·ªë l√† bao nhi√™u? hay m·ªôt c√°ch h·ªèi kh√°c: c·ª• th·ªÉ quan h·ªá One-to-N ƒë√≥ l√† <code>One-to-few</code>, <code>One-to-many</code>, <code>One-to-squillions</code>? Tu·ª≥ thu·ªôc v√†o c√¢u tr·∫£ l·ªùi m√† c√°ch thi·∫øt k·∫ø trong nosql t∆∞∆°ng ·ª©ng s·∫Ω kh√°c nhau.</p>
<h2 id="one-to-few">One-to-few</h2>
<p>L∆∞u tr·ªØ d∆∞ th·ª´a ( hay l·∫∑p l·∫°i ) ƒë·ªÉ gi·∫£m b·ªõt vi·ªác join khi c·∫ßn l·∫•y d·ªØ li·ªáu l√† m·ªôt ƒë·∫∑c t√≠nh c·ªßa nosql. Trong tr∆∞·ªùng h·ª£p quan h·ªá One-to-N l√† One-to-few, m·ªôt c√°ch h·ª£p l√Ω ƒë·ªÉ l∆∞u d·ªØ li·ªáu l√† <strong>l∆∞u tr·ª±c ti·∫øp c√°c th√†nh ph·∫ßn d·ªØ li·ªáu N trong d·ªØ li·ªáu One</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; db.person.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  name: <span style="color:#d20;background-color:#fff0f0">&#39;khanhtc&#39;</span>,
</span></span><span style="display:flex;"><span>  dob: <span style="color:#d20;background-color:#fff0f0">&#39;1994-01-01&#39;</span>
</span></span><span style="display:flex;"><span>  addresses : [
</span></span><span style="display:flex;"><span>    { city: <span style="color:#d20;background-color:#fff0f0">&#39;Tokyo&#39;</span>, cc: <span style="color:#d20;background-color:#fff0f0">&#39;JPN&#39;</span> },
</span></span><span style="display:flex;"><span>    { city: <span style="color:#d20;background-color:#fff0f0">&#39;Hanoi&#39;</span>, cc: <span style="color:#d20;background-color:#fff0f0">&#39;VNM&#39;</span> }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>D·ªÖ th·∫•y s·ªë l∆∞·ª£ng d·ªØ li·ªáu ƒë·ªãa ch·ªâ l√† nh·ªè v√† khi t√≠nh ƒë·∫øn vi·ªác query 2 b·∫£ng ho·∫∑c join b·∫£ng ƒë·ªÉ l·∫•y d·ªØ li·ªáu, vi·ªác l∆∞u tr·ªØ tr·ª±c ti·∫øp th√¥ng tin ƒë·ªãa ch·ªâ d∆∞·ªõi d·∫°ng m·∫£ng hi·ªáu qu·∫£ h∆°n.</p>
<h2 id="one-to-many">One-to-many</h2>
<p>Khi l·ª±c l∆∞·ª£ng (cardinality) c·ªßa t·∫≠p N trong quan h·ªá One-to-N ƒë·ªß l·ªõn ( c·ª° h√†ng trƒÉm ch·∫≥ng h·∫°n ), vi·ªác l∆∞u tr·ªØ l·∫∑p l·∫°i h√†ng trƒÉm d·ªØ li·ªáu c·ªßa t·∫≠p N trong m·ªói document d·ªØ li·ªáu c·ªßa t·∫≠p One l√† d∆∞ th·ª´a qu√° l·ªõn. M·ªôt c√°ch ƒë∆°n gi·∫£n, gi·ªëng <strong>nh∆∞ trog c∆° s·ªü d·ªØ li·ªáu quan h·ªá, l∆∞u tr·ªØ key tr·ªè ƒë·∫øn d·ªØ li·ªáu c·ªßa ki·ªÉu N trong ki·ªÉu One</strong> l√† m·ªôt c√°ch h·ª£p l√Ω ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y.</p>
<p>V√≠ d·ª• m·ªôt product nh∆∞ oto ch·∫≥ng h·∫°n, ƒë∆∞·ª£c t·∫°o th√†nh t·ª´ v√†i trƒÉm chi ti·∫øt kh√°c nhau.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; db.parts.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _id : ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;AAAA&#39;</span>),
</span></span><span style="display:flex;"><span>    partno : <span style="color:#d20;background-color:#fff0f0">&#39;123-aff-456&#39;</span>,
</span></span><span style="display:flex;"><span>    name : <span style="color:#d20;background-color:#fff0f0">&#39;#4 grommet&#39;</span>,
</span></span><span style="display:flex;"><span>    qty: 94,
</span></span><span style="display:flex;"><span>    cost: 0.94,
</span></span><span style="display:flex;"><span>    price: 3.99
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>&gt; db.cars.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    name : <span style="color:#d20;background-color:#fff0f0">&#39;mini cooper&#39;</span>,
</span></span><span style="display:flex;"><span>    manufacturer : <span style="color:#d20;background-color:#fff0f0">&#39;BMW&#39;</span>,
</span></span><span style="display:flex;"><span>    catalog_number: 1234,
</span></span><span style="display:flex;"><span>    parts : [     // array of references to Part documents
</span></span><span style="display:flex;"><span>        ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;AAAA&#39;</span>),    // reference to the <span style="color:#888">#4 grommet above</span>
</span></span><span style="display:flex;"><span>        ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;F17C&#39;</span>),    // reference to a different Part
</span></span><span style="display:flex;"><span>        ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;D2AA&#39;</span>),
</span></span><span style="display:flex;"><span>        // etc
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ƒê·ªÉ query d·ªØ li·ªáu, ta c·∫ßn 2 query ri√™ng bi·ªát cho tr∆∞·ªùng h·ª£p n√†y</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>// Fetch the Cars document identified by this catalog number
</span></span><span style="display:flex;"><span>&gt; <span style="color:#369">product</span> = db.cars.findOne({catalog_number: 1234});
</span></span><span style="display:flex;"><span>// Fetch all the Parts that are linked to this Car
</span></span><span style="display:flex;"><span>&gt; <span style="color:#369">product_parts</span> = db.parts.find({_id: { <span style="color:#369">$in</span> : product.parts } } ).toArray() ;
</span></span></code></pre></div><p>M·ªôt ƒëi·ªÉm c·∫ßn ch√∫ √Ω l√† khi d·ªØ li·ªáu c·ªßa t·∫≠p N th∆∞·ªùng xuy√™n b·ªã thay ƒë·ªïi, vi·ªác l∆∞u ri√™ng d·ªØ li·ªáu ki·ªÉu N th√†nh 1 collections gi√∫p cho vi·ªác update b·ªõt t·ªën k√©m h∆°n ( t∆∞∆°ng t·ª± nh∆∞ khi l∆∞u d·ªØ li·ªáu trong sql ).</p>
<h2 id="one-to-squillions">One-to-squillions</h2>
<p>M·ªôt v√≠ d·ª• ƒëi·ªÉn h√¨nh c·ªßa ki·ªÉu d·ªØ li·ªáu d·∫°ng n√†y l√† d·ªØ li·ªáu log h·ªá th·ªëng, ch·∫≥ng h·∫°n log tr·∫°ng th√°i c·ªßa c√°c host trong h·ªá th·ªëng.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; db.hosts.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _id : ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;AAAB&#39;</span>),
</span></span><span style="display:flex;"><span>    name : <span style="color:#d20;background-color:#fff0f0">&#39;goofy.example.com&#39;</span>,
</span></span><span style="display:flex;"><span>    ipaddr : <span style="color:#d20;background-color:#fff0f0">&#39;127.66.66.66&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>&gt; db.logmsg.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#038">time</span> : ISODate(<span style="color:#d20;background-color:#fff0f0">&#34;2014-03-28T09:42:41.382Z&#34;</span>),
</span></span><span style="display:flex;"><span>message : <span style="color:#d20;background-color:#fff0f0">&#39;cpu is on fire!&#39;</span>,
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>B·∫•t c·ª© d·ªØ li·ªáu ki·ªÉu d·∫°ng log n√†o c≈©ng ƒë·ªÅu r·∫•t l·ªõn v√† tƒÉng c·ª±c nhanh, m·ªôt c√°ch hi·ªáu qu·∫£ ƒë·ªÉ th·ªÉ hi·ªán m·ªói quan h·ªá One-to-N gi·ªØ host v√† log thu·ªôc v·ªÅ n√≥ l√† <strong>ƒë·ªÉ d·ªØ li·ªáu ki·ªÉu N (log) gi·ªØ relation ƒë·∫øn d·ªØ li·ªáu ki·ªÉu One (host)</strong>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; db.logmsg.findOne()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#038">time</span> : ISODate(<span style="color:#d20;background-color:#fff0f0">&#34;2014-03-28T09:42:41.382Z&#34;</span>),
</span></span><span style="display:flex;"><span>message : <span style="color:#d20;background-color:#fff0f0">&#39;cpu is on fire!&#39;</span>,
</span></span><span style="display:flex;"><span>host: ObjectID(<span style="color:#d20;background-color:#fff0f0">&#39;AAAB&#39;</span>)       // Reference to the Host document
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Khi ƒë√≥ query d·ªØ li·ªáu log theo host s·∫Ω tr·ªü th√†nh</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>// find the parent ‚Äòhost‚Äô document
</span></span><span style="display:flex;"><span>&gt; <span style="color:#369">host</span> = db.hosts.findOne({ipaddr : <span style="color:#d20;background-color:#fff0f0">&#39;127.66.66.66&#39;</span>});  // assumes unique index
</span></span><span style="display:flex;"><span>// find the most recent <span style="color:#00d;font-weight:bold">5000</span> log message documents linked to that host
</span></span><span style="display:flex;"><span>&gt; <span style="color:#369">last_5k_msg</span> = db.logmsg.find({host: host._id}).sort({<span style="color:#038">time</span> : -1}).limit(5000).toArray()
</span></span></code></pre></div><p>to be continue&hellip;</p>

			</div>
			
			<div>
				<ul id="tags">
					
					<li><a href="/tags/database">database</a></li>
					
					<li><a href="/tags/design">design</a></li>
					
				</ul>
			</div>
			
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/cncf-ambassador-annoucement/">Cncf Ambassador Annoucement</a></li>
				
				<li><a href="/posts/kadane-and-its-applications/">From subarray problems to Kadane and applications</a></li>
				
				<li><a href="/posts/an-approach-for-dp-problem/">An Approach for DP Problem</a></li>
				
				<li><a href="/posts/some-thought-about-tactics/">A breakthrough of my mind</a></li>
				
				<li><a href="/posts/concurrent-unit/">Process, Thread and Routine</a></li>
				
			</ul>
		</div>
	</div>
</aside>

<aside>
	<div>
    		
			<div>
				<h3>TAGS</h3>
			</div>
			<div>
				<ul>
					
					<li><a href="/tags/algorithm">algorithm</a></li>
					
					<li><a href="/tags/annoucement">annoucement</a></li>
					
					<li><a href="/tags/approx">approx</a></li>
					
					<li><a href="/tags/architecture">architecture</a></li>
					
					<li><a href="/tags/c/c&#43;&#43;">c/c&#43;&#43;</a></li>
					
					<li><a href="/tags/cncf">cncf</a></li>
					
					<li><a href="/tags/code">code</a></li>
					
					<li><a href="/tags/community">community</a></li>
					
					<li><a href="/tags/compiler">compiler</a></li>
					
					<li><a href="/tags/concurrent">concurrent</a></li>
					
					<li><a href="/tags/database">database</a></li>
					
					<li><a href="/tags/design">design</a></li>
					
					<li><a href="/tags/dev%20tool">dev tool</a></li>
					
					<li><a href="/tags/golang">golang</a></li>
					
					<li><a href="/tags/javascript">javascript</a></li>
					
					<li><a href="/tags/lock">lock</a></li>
					
					<li><a href="/tags/manual">manual</a></li>
					
					<li><a href="/tags/memory">memory</a></li>
					
					<li><a href="/tags/networks">networks</a></li>
					
					<li><a href="/tags/nodejs">nodejs</a></li>
					
					<li><a href="/tags/oop">oop</a></li>
					
					<li><a href="/tags/os">os</a></li>
					
					<li><a href="/tags/package%20manager">package manager</a></li>
					
					<li><a href="/tags/programming">programming</a></li>
					
					<li><a href="/tags/react">react</a></li>
					
					<li><a href="/tags/tactics">tactics</a></li>
					
					<li><a href="/tags/thinking">thinking</a></li>
					
					<li><a href="/tags/tree">tree</a></li>
					
					<li><a href="/tags/trick">trick</a></li>
					
				</ul>
			</div>
		
	</div>
</aside>



	<footer id="footer">
	<p>&copy; 2017-2024 <a href="https://khanhtc1202.github.io/">khanhtc&#39;s blog</a> | <a href="https://khanhtc1202.github.io/index.xml">RSS</a></p>
	<section><script async src="https://cse.google.com/cse.js?cx=009971123916912295303:lpg9aljzbui"></script>

	</section>
</footer>

</body>
</html>
